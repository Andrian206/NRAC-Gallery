<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toko Ikan - Homepage</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/global.css">
    <link rel="stylesheet" href="assets/css/home.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <!-- ==================== HEADER ==================== -->
    <header>
        <div class="container">
            <div class="header-content">
                <!-- Logo -->
                <a href="index.html" class="logo">
                    <img src="assets/fish.png" alt="Logo Toko Ikan">
                </a>

                <!-- Search Bar -->
                <div class="search-wrapper">
                    <input type="text" id="searchInput" placeholder="Ikan anda menunggu anda" class="search-input">
                </div>

                <!-- Navigation (Guest) -->
                <div class="nav-buttons" id="navGuest">
                    <a href="#" class="btn-link" onclick="openModal('signupModal'); return false;">Sign up</a>
                    <a href="#" class="btn-outline" onclick="openModal('signinModal'); return false;">Sign in</a>
                </div>

                <!-- Navigation (User - Hidden by default) -->
                <div class="nav-buttons hidden" id="navUser">
                    <a href="cart.html" class="btn-link">Keranjang</a>
                    <a href="profile.html" class="btn-outline">Profile</a>
                </div>
            </div>
        </div>
    </header>

    <!-- ==================== MAIN CONTENT ==================== -->
    <main>
        <div class="container">
            <!-- Filter -->
            <div class="filter-wrapper">
                <a href="admin.html" class="btn-filter hidden" id="adminBtn" style="margin-right: 10px;">+ Admin</a>
                <button class="btn-filter" onclick="toggleFilter()">Filter</button>
            </div>

            <!-- Products Grid -->
            <div class="products-grid" id="productsGrid">
                <!-- Loading State -->
                <div class="loading" id="loadingState">
                    <div class="loading-spinner"></div>
                    <p>Memuat data ikan...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- ==================== FOOTER ==================== -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <a href="index.html" class="logo">
                    <img src="assets/fish.png" alt="Logo Toko Ikan">
                </a>
            </div>
        </div>
    </footer>

    <!-- ==================== MODALS ==================== -->
    
    <!-- Sign In Modal -->
    <div class="modal-overlay" id="signinModal">
        <div class="modal">
            <button class="modal-close" onclick="closeModal('signinModal')">&times;</button>
            <h2 class="modal-title">Sign In</h2>
            <div class="auth-error" id="signinError"></div>
            <form id="signinForm" onsubmit="handleSignIn(event)">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="signinEmail" required placeholder="Masukkan email">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="signinPassword" required placeholder="Masukkan password">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Sign In</button>
            </form>
            <div class="auth-footer">
                Belum punya akun? <a href="#" onclick="switchModal('signinModal', 'signupModal'); return false;">Sign Up</a>
            </div>
        </div>
    </div>

    <!-- Sign Up Modal -->
    <div class="modal-overlay" id="signupModal">
        <div class="modal">
            <button class="modal-close" onclick="closeModal('signupModal')">&times;</button>
            <h2 class="modal-title">Sign Up</h2>
            <div class="auth-error" id="signupError"></div>
            <div class="auth-success" id="signupSuccess"></div>
            <form id="signupForm" onsubmit="handleSignUp(event)">
                <div class="form-group">
                    <label class="form-label">Nama</label>
                    <input type="text" class="form-input" id="signupNama" required placeholder="Masukkan nama">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="signupEmail" required placeholder="Masukkan email">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="signupPassword" required placeholder="Minimal 6 karakter" minlength="6">
                </div>
                <button type="submit" class="btn btn-success" style="width: 100%;">Sign Up</button>
            </form>
            <div class="auth-footer">
                Sudah punya akun? <a href="#" onclick="switchModal('signupModal', 'signinModal'); return false;">Sign In</a>
            </div>
        </div>
    </div>

    <!-- ==================== SCRIPTS ==================== -->
    <script src="assets/js/supabase.js"></script>
    <script>
        // ==========================================
        // HOMEPAGE SCRIPTS
        // ==========================================

        // Load products on page load
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üè† Homepage loaded');
            checkUserSession();
            await loadProducts();
        });

        // Check user session
        function checkUserSession() {
            try {
                const user = getCurrentUser();
                const adminBtn = document.getElementById('adminBtn');
                
                if (user) {
                    console.log('üë§ User logged in:', user.email, '| Role:', user.role);
                    document.getElementById('navGuest').classList.add('hidden');
                    document.getElementById('navUser').classList.remove('hidden');
                    
                    // Show admin button only for admin users
                    if (user.role === 'admin') {
                        adminBtn.classList.remove('hidden');
                        console.log('üîë Admin access granted');
                    } else {
                        adminBtn.classList.add('hidden');
                    }
                } else {
                    console.log('üë§ User not logged in');
                    document.getElementById('navGuest').classList.remove('hidden');
                    document.getElementById('navUser').classList.add('hidden');
                    adminBtn.classList.add('hidden');
                }
            } catch (error) {
                console.error('Session check error:', error);
            }
        }

        // Load products from database
        async function loadProducts(searchQuery = '') {
            const grid = document.getElementById('productsGrid');
            
            // Show loading
            grid.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Memuat data ikan...</p>
                </div>
            `;

            try {
                // Fetch data
                let ikanList = await getAllIkan(STATUS_IKAN.TERSEDIA);
                console.log('üì¶ Products loaded:', ikanList.length);

                // Filter by search
                if (searchQuery) {
                    const query = searchQuery.toLowerCase();
                    ikanList = ikanList.filter(ikan => 
                        ikan.kode_ikan.toLowerCase().includes(query) ||
                        ikan.lokasi.toLowerCase().includes(query) ||
                        (ikan.kategori && ikan.kategori.toLowerCase().includes(query))
                    );
                }

                // Clear grid
                grid.innerHTML = '';

                // Check if empty
                if (ikanList.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <h3>Belum ada ikan tersedia</h3>
                            <p>Silakan tambahkan ikan melalui halaman Admin</p>
                            <a href="admin.html" class="btn btn-primary" style="margin-top: 20px;">Buka Admin</a>
                        </div>
                    `;
                    return;
                }

                // Render cards
                ikanList.forEach(ikan => {
                    const card = createProductCard(ikan);
                    grid.appendChild(card);
                });
            } catch (error) {
                console.error('Load products error:', error);
                grid.innerHTML = `
                    <div class="empty-state">
                        <h3>Terjadi kesalahan</h3>
                        <p>Tidak dapat memuat data. Silakan refresh halaman.</p>
                    </div>
                `;
            }
        }

        // Create product card element
        function createProductCard(ikan) {
            const card = document.createElement('div');
            card.className = 'card';
            card.onclick = () => window.location.href = `detail.html?id=${ikan.id}`;

            card.innerHTML = `
                <div class="card-image">
                    ${ikan.url_foto 
                        ? `<img src="${ikan.url_foto}" alt="${ikan.kode_ikan}" onerror="this.style.display='none'">`
                        : ''}
                </div>
                <div class="card-info">
                    <div class="card-id">${ikan.kode_ikan}</div>
                    <div class="card-price">${formatRupiah(ikan.harga)}</div>
                    <div class="card-location">${ikan.lokasi}</div>
                </div>
            `;

            return card;
        }

        // Search functionality
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                loadProducts(e.target.value);
            }, 300);
        });

        // ==========================================
        // MODAL FUNCTIONS
        // ==========================================

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            // Clear errors
            const errorEl = document.querySelector(`#${modalId} .auth-error`);
            const successEl = document.querySelector(`#${modalId} .auth-success`);
            if (errorEl) {
                errorEl.textContent = '';
                errorEl.classList.remove('show');
            }
            if (successEl) {
                successEl.textContent = '';
                successEl.classList.remove('show');
            }
        }

        function switchModal(fromId, toId) {
            closeModal(fromId);
            setTimeout(() => openModal(toId), 200);
        }

        // Close modal when clicking outside
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        // ==========================================
        // AUTH HANDLERS
        // ==========================================

        async function handleSignIn(e) {
            e.preventDefault();
            const email = document.getElementById('signinEmail').value;
            const password = document.getElementById('signinPassword').value;
            const errorEl = document.getElementById('signinError');

            errorEl.textContent = 'Memproses...';
            errorEl.classList.add('show');

            const result = await signIn(email, password);
            
            if (result.success) {
                closeModal('signinModal');
                showNotification('Login berhasil!', 'success');
                checkUserSession();
            } else {
                errorEl.textContent = result.error;
                errorEl.classList.add('show');
            }
        }

        async function handleSignUp(e) {
            e.preventDefault();
            const nama = document.getElementById('signupNama').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const errorEl = document.getElementById('signupError');
            const successEl = document.getElementById('signupSuccess');

            errorEl.textContent = '';
            errorEl.classList.remove('show');
            successEl.textContent = 'Memproses...';
            successEl.classList.add('show');

            const result = await signUp(email, password, nama);
            
            if (result.success) {
                closeModal('signupModal');
                showNotification('Registrasi berhasil! Selamat datang!', 'success');
                document.getElementById('signupForm').reset();
                checkUserSession();
            } else {
                successEl.classList.remove('show');
                errorEl.textContent = result.error;
                errorEl.classList.add('show');
            }
        }

        // Filter toggle (placeholder)
        function toggleFilter() {
            showNotification('Filter akan segera hadir!', 'info');
        }
    </script>

</body>
</html>