<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keranjang - Toko Ikan</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/global.css">
    <link rel="stylesheet" href="assets/css/cart.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <!-- ==================== HEADER ==================== -->
    <header>
        <div class="container">
            <div class="header-content">
                <!-- Logo -->
                <a href="index.html" class="logo">
                    <img src="assets/fish.png" alt="Logo Toko Ikan">
                </a>

                <!-- Search Bar -->
                <div class="search-wrapper">
                    <input type="text" id="searchInput" placeholder="Ikan anda menunggu anda" class="search-input">
                </div>

                <!-- Navigation (User) -->
                <div class="nav-buttons" id="navUser">
                    <a href="cart.html" class="btn-link active">Keranjang</a>
                    <a href="profile.html" class="btn-outline">Profile</a>
                </div>
            </div>
        </div>
    </header>

    <!-- ==================== MAIN CONTENT ==================== -->
    <main>
        <div class="container">
            <!-- Back Link -->
            <a href="index.html" class="back-link">&larr; Kembali ke Beranda</a>
            
            <!-- Page Title -->
            <h1 class="page-title">Keranjang Belanja</h1>

            <!-- Cart Layout -->
            <div class="cart-layout" id="cartLayout">
                <!-- Loading -->
                <div class="loading" style="grid-column: 1 / -1;">
                    <div class="loading-spinner"></div>
                    <p>Memuat keranjang...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- ==================== FOOTER ==================== -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <a href="index.html" class="logo">
                    <img src="assets/fish.png" alt="Logo Toko Ikan">
                </a>
            </div>
        </div>
    </footer>

    <!-- ==================== SCRIPTS ==================== -->
    <script src="assets/js/supabase.js"></script>
    <script>
        // ==========================================
        // CART PAGE SCRIPTS
        // ==========================================

        let cartItems = [];
        let selectedItems = new Set();

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ðŸ›’ Cart page loaded');
            
            // Check if user is logged in
            const user = await getCurrentUser();
            if (!user) {
                showNotification('Silakan login terlebih dahulu', 'error');
                setTimeout(() => window.location.href = 'index.html', 1500);
                return;
            }
            
            console.log('ðŸ‘¤ User:', user.email);
            await loadCart();
        });

        // Load cart items
        async function loadCart() {
            const layout = document.getElementById('cartLayout');
            
            try {
                cartItems = await getKeranjangItems();
                console.log('ðŸ›’ Cart items:', cartItems.length);

                if (cartItems.length === 0) {
                    layout.innerHTML = `
                        <div class="cart-empty">
                            <h3>Keranjang Kosong</h3>
                            <p>Anda belum menambahkan ikan ke keranjang.</p>
                            <a href="index.html" class="btn btn-primary">Belanja Sekarang</a>
                        </div>
                    `;
                    return;
                }

                // Initialize all items as selected
                cartItems.forEach(item => selectedItems.add(item.id));
                renderCart();
            } catch (error) {
                console.error('Load cart error:', error);
                layout.innerHTML = `
                    <div class="cart-empty">
                        <h3>Terjadi Kesalahan</h3>
                        <p>Tidak dapat memuat keranjang.</p>
                        <a href="index.html" class="btn btn-primary">Kembali</a>
                    </div>
                `;
            }
        }

        // Render cart
        function renderCart() {
            const layout = document.getElementById('cartLayout');

            // Calculate total
            const total = cartItems
                .filter(item => selectedItems.has(item.id))
                .reduce((sum, item) => sum + item.harga, 0);

            const selectedCount = selectedItems.size;

            layout.innerHTML = `
                <!-- Cart Items -->
                <div class="cart-items">
                    ${cartItems.map(item => `
                        <div class="cart-item">
                            <input type="checkbox" 
                                   class="cart-item-checkbox" 
                                   ${selectedItems.has(item.id) ? 'checked' : ''}
                                   onchange="toggleItem('${item.id}')">
                            <div class="cart-item-image">
                                ${item.url_foto 
                                    ? `<img src="${item.url_foto}" alt="${item.kode_ikan}" onerror="this.style.display='none'">` 
                                    : ''}
                            </div>
                            <div class="cart-item-info">
                                <div class="cart-item-kode">${item.kode_ikan}</div>
                                <div class="cart-item-lokasi">${item.lokasi || ''}</div>
                            </div>
                            <div class="cart-item-price">${formatRupiah(item.harga)}</div>
                            <button class="cart-item-remove" onclick="removeItem('${item.id}')" title="Hapus">Ã—</button>
                        </div>
                    `).join('')}
                </div>

                <!-- Cart Summary -->
                <div class="cart-summary">
                    <h3 class="cart-summary-title">Ringkasan Belanja</h3>
                    <div class="cart-summary-row">
                        <span class="cart-summary-label">Item dipilih</span>
                        <span class="cart-summary-value">${selectedCount} ikan</span>
                    </div>
                    <div class="cart-summary-row cart-summary-total">
                        <span class="cart-summary-label">Total</span>
                        <span class="cart-summary-value">${formatRupiah(total)}</span>
                    </div>
                    <button class="btn btn-success btn-checkout" onclick="handleCheckout()" ${selectedCount === 0 ? 'disabled' : ''}>
                        Checkout (${selectedCount})
                    </button>
                </div>
            `;
        }

        // Toggle item selection
        function toggleItem(id) {
            if (selectedItems.has(id)) {
                selectedItems.delete(id);
            } else {
                selectedItems.add(id);
            }
            renderCart();
        }

        // Remove item from cart
        function removeItem(id) {
            removeFromKeranjang(id);
            cartItems = cartItems.filter(item => item.id !== id);
            selectedItems.delete(id);
            
            if (cartItems.length === 0) {
                loadCart();
            } else {
                renderCart();
            }
            
            showNotification('Item dihapus dari keranjang', 'info');
        }

        // Handle checkout
        async function handleCheckout() {
            if (selectedItems.size === 0) {
                showNotification('Pilih minimal 1 item', 'error');
                return;
            }

            const ikanIds = Array.from(selectedItems);
            
            try {
                showNotification('Memproses checkout...', 'info');

                // Update status to Dipesan
                for (const id of ikanIds) {
                    await updateStatusIkan(id, STATUS_IKAN.DIPESAN);
                }

                // Remove from local cart
                ikanIds.forEach(id => removeFromKeranjang(id));

                showNotification('Checkout berhasil! Pesanan Anda sedang diproses.', 'success');
                
                setTimeout(() => {
                    window.location.href = 'profile.html';
                }, 2000);
            } catch (error) {
                console.error('Checkout error:', error);
                showNotification('Checkout gagal. Silakan coba lagi.', 'error');
            }
        }

        // Search redirect
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                window.location.href = `index.html?search=${encodeURIComponent(e.target.value)}`;
            }
        });
    </script>

</body>
</html>
